apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: python-app-alerts
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: python-app.slo.rules
      rules:

      # 1️ High Latency (P95)
      - alert: PythonAppHighLatency
        expr: |
          histogram_quantile(
            0.95,
            sum by (le) (
              rate(http_request_duration_seconds_bucket{app="python-app"}[5m])
            )
          ) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency detected (P95 > 1s)"
          description: "P95 latency for python-app has exceeded 1s for 5 minutes."

      # 2️ High Error Rate (5xx)
      - alert: PythonAppHighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{app="python-app",status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{app="python-app"}[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High 5xx error rate (>5%)"
          description: "More than 5% of requests are failing with 5xx responses."

      # 3️ Pod Restarts
      - alert: PythonAppPodRestarts
        expr: |
          increase(
            kube_pod_container_status_restarts_total{
              namespace="application",
              pod=~"python-app.*"
            }[10m]
          ) > 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Pod restarting frequently"
          description: "One or more python-app pods restarted more than once in 10 minutes."

      # 4 HPA Saturation (only fires if HPA exists)
      - alert: PythonAppHPASaturation
        expr: |
          kube_horizontalpodautoscaler_status_current_replicas{
            namespace="application",
            horizontalpodautoscaler=~"python-app.*"
          }
          ==
          kube_horizontalpodautoscaler_spec_max_replicas{
            namespace="application",
            horizontalpodautoscaler=~"python-app.*"
          }
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "HPA at maximum replicas"
          description: "python-app HPA has been running at max replicas for 10 minutes."
